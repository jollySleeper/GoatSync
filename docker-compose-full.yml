# GoatSync Full Stack - With EteSync-DAV for CalDAV/CardDAV support
# 
# This includes etesync-dav bridge for standard calendar apps like:
# - Apple Calendar/Contacts
# - Thunderbird
# - GNOME Evolution
# - Any CalDAV/CardDAV compatible app
#
# Usage: docker compose -f docker-compose-full.yml up -d
# 
# Endpoints:
#   - GoatSync API:    http://localhost:3735 (for EteSync apps)
#   - EteSync-DAV:     http://localhost:37358 (for standard calendar apps)
#
# Setup:
#   1. Create account via EteSync app pointing to http://YOUR_IP:3735
#   2. Open http://localhost:37358 to add your account to etesync-dav
#   3. Use the generated DAV password for Thunderbird/Apple Calendar

services:
  # ═══════════════════════════════════════════════════════════
  # DATABASE - PostgreSQL
  # ═══════════════════════════════════════════════════════════
  postgres:
    image: postgres:15-alpine
    container_name: goatsync-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: goatsync
      POSTGRES_PASSWORD: ${DB_PASSWORD:-goatsync}
      POSTGRES_DB: goatsync
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U goatsync"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════
  # REDIS - For WebSocket real-time sync
  # ═══════════════════════════════════════════════════════════
  redis:
    image: redis:7-alpine
    container_name: goatsync-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════
  # GOATSYNC - Main EteSync-compatible server
  # ═══════════════════════════════════════════════════════════
  goatsync:
    # Use ghcr.io image (latest will be available after workflow update)
    image: ghcr.io/jollysleeper/goatsync:main
    # Or build locally:
    # build: .
    container_name: goatsync
    restart: unless-stopped
    ports:
      - "3735:3735"
    environment:
      DATABASE_URL: postgres://goatsync:${DB_PASSWORD:-goatsync}@postgres:5432/goatsync?sslmode=disable
      SECRET_KEY: ${SECRET_KEY:-change_this_to_a_secure_32_char_key}
      REDIS_URL: redis://redis:6379/0
      PORT: "3735"
      DEBUG: "${DEBUG:-false}"
    volumes:
      - chunk_data:/data/chunks
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3735/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ═══════════════════════════════════════════════════════════
  # ETESYNC-DAV - CalDAV/CardDAV bridge for standard apps
  # ═══════════════════════════════════════════════════════════
  # Provides CalDAV/CardDAV interface for:
  # - Apple Calendar & Contacts
  # - Thunderbird
  # - Evolution / GNOME Calendar
  # - Any standard CalDAV/CardDAV client
  #
  # Web UI: http://localhost:37358
  # Add your EteSync account there, then use the generated
  # DAV password in your calendar app.
  etesync-dav:
    image: etesync/etesync-dav:latest
    container_name: etesync-dav
    restart: unless-stopped
    ports:
      - "37358:37358"
    environment:
      # Point to GoatSync (use Docker internal hostname)
      ETESYNC_URL: http://goatsync:3735
    volumes:
      - dav_data:/data
    depends_on:
      goatsync:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  chunk_data:
  dav_data:
